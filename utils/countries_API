import requests
import os
import json
from datetime import datetime, timedelta

COUNTRIES_API_URL = "https://restcountries.com/v3.1/all"
FIELDS = "name, cca2, capital, car >side,currencies,flags,languages,maps"
CACHE_FILE = "countries_cache.json"
CACHE_EXPIRY_DAYS = 7

def get_countries():
    try:
        if os.path.exists(CACHE_FILE):
            with open(CACHE_FILE, 'r') as cache_file:
                cache_data = json.load(cache_file)
                last_updated = datetime.strptime(cache_data['last_updated'], '%Y-%m-%d')
                if (datetime.now() - last_updated).days < CACHE_EXPIRY_DAYS:
                    print("Using cached countries data.")
                    return cache_data
        
        # If cache is missing or expired, fetch fresh data from the API
        url = f"{COUNTRIES_API_URL}?fields={FIELDS}"
        print(f"Fetching countries from URL: {url}")
        response = requests.get(url)
        if response.status_code == 200:
            countries_data = response.json()

            # Update the cache with the new data and timestamp
            with open(CACHE_FILE, 'w') as cache_file:
                json.dump({
                    'timestamp': datetime.now().strftime('%Y-%m-%dT%H:%M:%S'),
                    'data': countries_data
                }, cache_file)

            return countries_data
        else:
            print(f"Error fetching countries: {response.status_code}, {response.text}")
            return None
    except Exception as e:
        print(f"Exception occurred: {e}")
        return None
 

